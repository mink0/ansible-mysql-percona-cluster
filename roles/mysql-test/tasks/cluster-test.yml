---

- set_fact:
    sample: "cluster-{{ ansible_date_time.iso8601_micro }}"
  when: "'mysql-master' in group_names"
  run_once: yes

- name: write sample to master ({{ sample }})
  command: mysql {{ mysql_test_db }} -e \
    "INSERT INTO {{ mysql_test_table }} values ('{{ sample }}')"
  when: "'mysql-master' in group_names"

- name: read sample ({{ sample }}) from every node
  command: mysql {{ mysql_test_db }} -NBe \
    "SELECT count(data) FROM {{ mysql_test_table }} WHERE data='{{ sample }}'"
  register: result
  until: result.stdout == "1"
  retries: 10
